<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Dash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color, #f3f4f6);
            color: var(--text-color, #1f2937);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Theme Variables --- */
        :root, body[data-theme='light'] {
            --bg-color: #f8fafc; --text-color: #1e293b; --tile-bg: #ffffff;
            --tile-shadow: rgba(0, 0, 0, 0.05); --text-muted: #64748b;
            --primary-color: #3b82f6; --primary-accent: #1d4ed8;
            --grid-border: #e2e8f0;
            /* Current/Past colors - Used by CSS rules */
            --grid-current-color-start: #60a5fa; --grid-current-color-end: #3b82f6; --grid-current-border: #2563eb;
            --grid-past-color-start: #e5e7eb; --grid-past-color-end: #d1d5db; --grid-past-border: #d1d5db;
            /* Future colors are handled by JS cycling */
            --progress-bg: #e2e8f0; --progress-fill: #3b82f6;
            --button-add-bg: #22c55e; --button-add-hover: #16a34a;
            --button-load-template-bg: #f97316; --button-load-template-hover: #ea580c; /* Orange for Load Template */
            --button-danger-bg: #ef4444; --button-danger-hover: #dc2626; /* Red for destructive actions */
            --input-border: #cbd5e1; --input-focus-ring: #60a5fa;
            --theme-button-bg: #e2e8f0; --theme-button-hover: #cbd5e1;
            --theme-button-active: #3b82f6; --theme-button-icon: #334155;
            --task-hover-bg: #f1f5f9; --task-completed-bg: #f8fafc;
            --task-delete-icon-color: #94a3b8; --task-delete-icon-hover-color: #ef4444;
            --tab-border: #e2e8f0; --tab-active-border: var(--primary-color); --tab-text: var(--text-muted); --tab-active-text: var(--primary-color);
            --history-entry-border: #f1f5f9;
            --modal-bg: var(--tile-bg); --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --button-secondary-bg: #e2e8f0; --button-secondary-hover: #cbd5e1; --button-secondary-text: #334155;
            --button-primary-bg: var(--primary-color); --button-primary-hover: var(--primary-accent); --button-primary-text: #ffffff;
            --textarea-bg: var(--bg-color);
            --active-hour-indicator: var(--primary-accent); /* Color for active hour top border */
        }
        body[data-theme='grey'] {
             --bg-color: #e5e7eb; --text-color: #1f2937; --tile-bg: #f9fafb; --tile-shadow: rgba(0, 0, 0, 0.05);
            --text-muted: #4b5563; --primary-color: #6b7280; --primary-accent: #374151;
            --grid-border: #d1d5db;
            --grid-current-color-start: #9ca3af; --grid-current-color-end: #6b7280; --grid-current-border: #4b5563;
            --grid-past-color-start: #e5e7eb; --grid-past-color-end: #d1d5db; --grid-past-border: #d1d5db;
            --progress-bg: #d1d5db; --progress-fill: #6b7280; --button-add-bg: #52525b; --button-add-hover: #3f3f46;
            --button-load-template-bg: #78716c; --button-load-template-hover: #57534e; /* Grey-Orange */
            --button-danger-bg: #7f1d1d; --button-danger-hover: #b91c1c; /* Darker Red */
            --input-border: #d1d5db; --input-focus-ring: #9ca3af; --theme-button-bg: #d1d5db;
            --theme-button-hover: #9ca3af; --theme-button-active: #6b7280; --theme-button-icon: #374151;
            --task-hover-bg: #f3f4f6; --task-completed-bg: #e5e7eb;
            --tab-border: #d1d5db; --tab-active-border: var(--primary-color); --tab-text: var(--text-muted); --tab-active-text: var(--primary-color);
            --history-entry-border: #f3f4f6;
            --button-secondary-bg: #d1d5db; --button-secondary-hover: #9ca3af; --button-secondary-text: #1f2937;
            --textarea-bg: var(--bg-color);
            --active-hour-indicator: var(--primary-accent);
        }
        body[data-theme='dark'] {
            --bg-color: #111827; --text-color: #f9fafb; --tile-bg: #1f2937; --tile-shadow: rgba(0, 0, 0, 0.2);
            --text-muted: #9ca3af; --primary-color: #60a5fa; --primary-accent: #93c5fd;
            --grid-border: #374151;
            --grid-current-color-start: #93c5fd; --grid-current-color-end: #60a5fa; --grid-current-border: #bfdbfe;
            --grid-past-color-start: #374151; --grid-past-color-end: #4b5563; --grid-past-border: #6b7280;
            --progress-bg: #374151; --progress-fill: #60a5fa; --button-add-bg: #16a34a; --button-add-hover: #15803d;
            --button-load-template-bg: #d97706; --button-load-template-hover: #b45309; /* Dark Orange */
            --button-danger-bg: #b91c1c; --button-danger-hover: #991b1b; /* Darker Red */
            --input-border: #4b5563; --input-focus-ring: #60a5fa; --theme-button-bg: #374151;
            --theme-button-hover: #4b5563; --theme-button-active: #60a5fa; --theme-button-icon: #d1d5db;
            --task-hover-bg: #374151; --task-completed-bg: #111827;
            --task-delete-icon-color: #6b7280; --task-delete-icon-hover-color: #f87171;
            --tab-border: #374151; --tab-active-border: var(--primary-color); --tab-text: var(--text-muted); --tab-active-text: var(--primary-color);
            --history-entry-border: #374151;
            --modal-bg: var(--tile-bg); --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --button-secondary-bg: #374151; --button-secondary-hover: #4b5563; --button-secondary-text: #d1d5db;
            --button-primary-text: #111827;
            --textarea-bg: #374151; /* Darker background for textarea in dark mode */
            --active-hour-indicator: var(--primary-accent);
        }

        /* --- Component Styles --- */
        .main-title { color: var(--text-color); }
        .attribution-link a { color: var(--primary-color); text-decoration: none; }
        .attribution-link a:hover { text-decoration: underline; color: var(--primary-accent); }

        .tile { background-color: var(--tile-bg); box-shadow: 0 4px 6px -1px var(--tile-shadow), 0 2px 4px -1px var(--tile-shadow); transition: background-color 0.3s ease; border-radius: 0.5rem; }
        .tile-title { color: var(--text-color); }
        .text-muted { color: var(--text-muted); }
        .text-primary { color: var(--primary-color); }
        .text-primary-accent { color: var(--primary-accent); }

        /* Time Block Styles (Shared) */
        .time-block {
            border-radius: 3px;
            flex-shrink: 0;
            transition: background 0.3s ease, border-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease, border-top-color 0.3s ease; /* Added border-top-color */
            overflow: hidden;
            border: 1px solid var(--grid-border);
            border-top-width: 1px; /* Default top border */
        }
        .time-block.past { background: linear-gradient(135deg, var(--grid-past-color-start), var(--grid-past-color-end)); border-color: var(--grid-past-border); opacity: 0.6; transform: scale(1); box-shadow: none; z-index: 1; }
        .time-block.current { background: linear-gradient(135deg, var(--grid-current-color-start), var(--grid-current-color-end)); border: 1px solid var(--grid-current-border); box-shadow: 0 0 6px 1px var(--grid-current-border); transform: scale(1.1); z-index: 10; position: relative; opacity: 1.0; }
        /* Future blocks get background set by JS */

        /* --- NEW: Style for slots within active hours --- */
        .time-block.active-hour-slot {
            border-top-width: 2px; /* Make top border thicker */
            border-top-color: var(--active-hour-indicator); /* Use indicator color */
        }
        /* Adjustments for specific states */
        .time-block.active-hour-slot.past {
             opacity: 0.7; /* Slightly less faded than normal past slots */
             /* Keep the active top border */
             border-top-color: var(--active-hour-indicator);
             /* Ensure other borders match the past state */
             border-left-color: var(--grid-past-border);
             border-right-color: var(--grid-past-border);
             border-bottom-color: var(--grid-past-border);
        }
         .time-block.active-hour-slot.current {
             /* Keep the current border style, which overrides the top border */
             border: 1px solid var(--grid-current-border);
             /* The general .current style already provides strong emphasis */
         }
         .time-block.active-hour-slot.future {
             /* Keep the active top border */
             border-top-color: var(--active-hour-indicator);
             /* Ensure other borders match the future state (which uses --grid-border) */
             border-left-color: var(--grid-border);
             border-right-color: var(--grid-border);
             border-bottom-color: var(--grid-border);
         }


        /* Active Hours Bar Specifics - REMOVED */
        /* #active-hours-bar .time-block { width: 16px; height: 16px; } */
        .bar-container { display: flex; flex-wrap: wrap; gap: 3px; width: 100%; }

        /* Full Day Slots Bar Specifics */
        #full-day-slots-bar .time-block { width: 18px; height: 18px; }
        #full-day-slots-bar { gap: 2px; margin-bottom: 1rem; } /* Keep margin for spacing */

        /* --- Other styles --- */
        .progress-bar-bg { background-color: var(--progress-bg); }
        .progress-bar-fill { background-color: var(--progress-fill); transition: width 0.5s ease-in-out, background-color 0.3s ease; }
        .task-list-container::-webkit-scrollbar, .history-log-container::-webkit-scrollbar, .modal-textarea::-webkit-scrollbar { width: 6px; }
        .task-list-container::-webkit-scrollbar-track, .history-log-container::-webkit-scrollbar-track, .modal-textarea::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 3px; }
        .task-list-container::-webkit-scrollbar-thumb, .history-log-container::-webkit-scrollbar-thumb, .modal-textarea::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }
        .task-list-container::-webkit-scrollbar-thumb:hover, .history-log-container::-webkit-scrollbar-thumb:hover, .modal-textarea::-webkit-scrollbar-thumb:hover { background: var(--text-color); }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--grid-border); transition: background-color 0.2s ease, opacity 0.3s ease; border-radius: 4px; }
        .task-item:last-child { border-bottom: none; }
        .task-item:hover { background-color: var(--task-hover-bg); }
        .task-item:hover .delete-button { opacity: 1; }
        .task-item label { display: flex; align-items: center; cursor: pointer; flex-grow: 1; margin-right: 0.5rem; }
        .task-item input[type="checkbox"] { margin-right: 0.75rem; accent-color: var(--primary-color); width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; }
        .task-item span { word-break: break-word; transition: color 0.3s ease; }
        .task-item.completed { opacity: 0.7; background-color: var(--task-completed-bg); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-muted); text-decoration-color: var(--text-muted); }
        .delete-button { opacity: 0; background: none; border: none; padding: 0.25rem; cursor: pointer; transition: opacity 0.2s ease, color 0.2s ease; color: var(--task-delete-icon-color); line-height: 1; flex-shrink: 0; }
        .delete-button:hover { color: var(--task-delete-icon-hover-color); }
        .delete-button svg { display: block; width: 16px; height: 16px; }
        .add-task-container { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .input-field { border: 1px solid var(--input-border); background-color: var(--tile-bg); color: var(--text-color); flex-grow: 1; border-radius: 0.375rem; padding: 0.6rem 0.75rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .input-field:focus { border-color: transparent; --tw-ring-color: var(--input-focus-ring); --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); outline: 2px solid transparent; outline-offset: 2px; }
        /* Base Button Style */
        .button-base { color: #fff; transition: background-color 0.2s ease; font-weight: 500; padding: 0.6rem 1rem; border-radius: 0.375rem; display: inline-flex; align-items: center; gap: 0.25rem; flex-shrink: 0; border: none; cursor: pointer; }
        .button-add { background-color: var(--button-add-bg); }
        .button-add:hover { background-color: var(--button-add-hover); }
        .button-load-template { background-color: var(--button-load-template-bg); }
        .button-load-template:hover { background-color: var(--button-load-template-hover); }
        .button-danger { background-color: var(--button-danger-bg); color: #fff; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease; }
        .button-danger:hover { background-color: var(--button-danger-hover); }
        /* Small Danger Button for Clear Tasks in main view */
        .button-danger-small { background-color: var(--button-danger-bg); color: #fff; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; /* Smaller text */ line-height: 1; transition: background-color 0.2s ease; border: none; cursor: pointer; }
        .button-danger-small:hover { background-color: var(--button-danger-hover); }

        .button-add svg, .button-load-template svg { /* SVG already inline */ }
        .theme-switcher { background-color: var(--tile-bg); border-radius: 0.5rem; padding: 0.5rem; box-shadow: 0 2px 4px -1px var(--tile-shadow); margin-bottom: 1.5rem; }
        .theme-button { background-color: var(--theme-button-bg); border-radius: 0.375rem; padding: 0.5rem; transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; border: 2px solid transparent; /* Keep transparent border for layout consistency */ }
        .theme-button:hover { background-color: var(--theme-button-hover); }
        .theme-button.active {
            /* Active state is now indicated only by the icon color change below */
        }
        .theme-button svg { color: var(--theme-button-icon); transition: color 0.3s ease; width: 20px; height: 20px; display: block; }
        .theme-button.active svg { color: var(--theme-button-active); } /* This rule makes the icon color change */
        .datetime-icon { color: var(--primary-color); flex-shrink: 0; width:20px; height:20px; }
        .tab-container { border-bottom: 1px solid var(--tab-border); margin-bottom: 1rem; }
        .tab-button { padding: 0.5rem 1rem; margin-bottom: -1px; border: none; border-bottom: 2px solid transparent; background: none; cursor: pointer; color: var(--tab-text); font-weight: 500; transition: color 0.2s ease, border-color 0.2s ease; }
        .tab-button:hover { color: var(--primary-color); }
        .tab-button.active { color: var(--tab-active-text); border-bottom-color: var(--tab-active-border); }
        .history-log-container { /* Shares scrollbar style */ }
        .history-entry { font-size: 0.875rem; padding: 0.5rem; border-bottom: 1px solid var(--history-entry-border); display: flex; justify-content: space-between; gap: 0.5rem; }
        .history-entry:last-child { border-bottom: none; }
        .history-timestamp { color: var(--text-muted); font-size: 0.75rem; white-space: nowrap; }
        .history-action { font-weight: 500; }
        .history-action-added { color: var(--button-add-bg); } .history-action-completed { color: var(--primary-color); }
        .history-action-uncompleted { color: var(--text-muted); } .history-action-deleted { color: var(--task-delete-icon-hover-color); }
        .history-action-template { color: var(--button-load-template-bg); } /* Style for template load */
        .history-action-cleared { color: var(--button-danger-bg); } /* Style for clear actions */
        .history-text { color: var(--text-color); word-break: break-word; }

        /* Modal Styles (Shared) */
        .modal-overlay { position: fixed; inset: 0; background-color: var(--modal-overlay-bg); z-index: 40; transition: opacity 0.3s ease-in-out; opacity: 0; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); background-color: var(--modal-bg); color: var(--text-color); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 90%; max-width: 500px; /* Added max-width */ z-index: 50; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; opacity: 0; pointer-events: none; }
        .modal.visible { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .modal-label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-muted); }
        .modal-select { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid var(--input-border); background-color: var(--bg-color); color: var(--text-color); margin-bottom: 1rem; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        /* Textarea for Template */
        .modal-textarea { width: 100%; min-height: 100px; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid var(--input-border); background-color: var(--textarea-bg); color: var(--text-color); margin-bottom: 0.5rem; font-size: 0.875rem; line-height: 1.4; resize: vertical; overflow-y: auto; /* Add scrollbar */ }
        .modal-textarea:focus { border-color: transparent; --tw-ring-color: var(--input-focus-ring); --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); outline: 2px solid transparent; outline-offset: 2px; }
        .modal-section { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--grid-border); }
        .modal-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-color); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .modal-danger-zone { display: flex; justify-content: center; /* Center the remaining button */ gap: 0.5rem; margin-top: 1rem; }
        .button-secondary { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease; border: none; cursor: pointer; }
        .button-secondary:hover { background-color: var(--button-secondary-hover); }
        .button-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease; border: none; cursor: pointer; }
        .button-primary:hover { background-color: var(--button-primary-hover); }

        /* Confirmation Modal Specific Styles */
        #confirm-modal { max-width: 400px; /* Smaller width */ }
        #confirm-message { margin-bottom: 1.5rem; font-size: 1rem; line-height: 1.5; }

        #settings-button { position: fixed; top: 1rem; left: 1rem; z-index: 30; background-color: var(--tile-bg); color: var(--text-muted); padding: 0.5rem; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid var(--grid-border); }
        #settings-button:hover { background-color: var(--theme-button-hover); color: var(--text-color); }
        #settings-button svg { display: block; width: 20px; height: 20px; }

    </style>
</head>
<body class="p-4 md:p-8">

    <button id="settings-button" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    </button>

    <div id="settings-overlay" class="modal-overlay"></div>
    <div id="settings-modal" class="modal">
        <h2 class="modal-title">Settings</h2>

        <div class="space-y-4">
            <h3 class="modal-section-title">Active Hours</h3>
            <div>
                <label for="setting-start-hour" class="modal-label">Start</label>
                <select id="setting-start-hour" class="modal-select"></select>
            </div>
            <div>
                <label for="setting-end-hour" class="modal-label">End</label>
                <select id="setting-end-hour" class="modal-select"></select>
            </div>
        </div>

        <div class="modal-section">
            <h3 class="modal-section-title">Daily Task Template</h3>
            <div>
                <label for="setting-task-template" class="modal-label">Define (one task per line)</label>
                <textarea id="setting-task-template" class="modal-textarea" placeholder="e.g.&#10;Review daily goals&#10;Check email&#10;Team meeting"></textarea>
                <button id="save-template-button" class="button-primary mt-2 text-sm py-1 px-3">Save Template</button>
                <p class="text-xs text-muted mt-1">Load template using the 'Load' button in the task list.</p>
            </div>
        </div>

        <div class="modal-section">
            <h3 class="modal-section-title text-red-600">Danger Zone</h3>
            <div class="modal-danger-zone">
                <button id="clear-history-button" class="button-danger text-sm">Clear History</button>
            </div>
            <p class="text-xs text-muted mt-1">This action cannot be undone.</p>
        </div>

        <div class="modal-buttons">
            <button id="close-settings-button" class="button-secondary">Close</button>
            <button id="save-settings-button" class="button-primary">Save Hours</button>
        </div>
    </div>

    <div id="confirm-overlay" class="modal-overlay"></div>
    <div id="confirm-modal" class="modal">
        <p id="confirm-message" class="text-center">Are you sure?</p>
        <div class="modal-buttons">
            <button id="confirm-no-button" class="button-secondary">Cancel</button>
            <button id="confirm-yes-button" class="button-danger">Yes, Proceed</button>
        </div>
    </div>

    <h1 class="main-title text-4xl md:text-5xl font-bold text-center mb-1">Daily Dash</h1>
    <p class="text-center text-sm text-muted mb-6 attribution-link">
        by <a href="https://www.linkedin.com/in/karthicobla/" target="_blank" rel="noopener noreferrer">Karthic</a>
    </p>

    <div class="theme-switcher max-w-xs mx-auto">
        <div class="flex justify-center gap-3">
            <button class="theme-button" data-theme-value="light" title="Light">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
            </button>
            <button class="theme-button" data-theme-value="grey" title="Grey">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path></svg>
            </button>
            <button class="theme-button" data-theme-value="dark" title="Dark">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="tile p-6 rounded-lg flex flex-col items-center justify-center text-center space-y-3">
                <div class="flex items-center justify-center space-x-3 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="datetime-icon"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                    <p id="date-display" class="text-lg text-muted whitespace-nowrap">Loading Date...</p>
                </div>
                <div class="flex items-center justify-center space-x-3 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="datetime-icon"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    <p id="time-display" class="font-medium text-2xl text-primary whitespace-nowrap">Loading Time...</p>
                </div>
            </div>

            <div class="tile p-6 rounded-lg flex flex-col items-center text-center justify-center">
                <div class="flex items-center space-x-3 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" x2="14" y1="2" y2="2"></line><line x1="12" x2="12" y1="5" y2="9"></line><circle cx="12" cy="14" r="8"></circle></svg>
                    <h2 class="tile-title text-xl font-semibold">Current 30-Min Slot</h2>
                </div>
                <div id="slot-timer-display" class="text-5xl font-bold text-primary mb-1">--:--</div>
                <p id="slots-passed" class="text-sm text-muted mb-3">-- slots passed today</p>
            </div>

            <div class="tile p-6 rounded-lg flex flex-col">
                 <h3 class="tile-title text-sm font-semibold mb-1 text-center md:text-left">
                    Full Day Slots (Active: <span id="active-hours-range-display-inline">--</span>)
                </h3>
                <div id="full-day-slots-bar" class="bar-container justify-center md:justify-start">
                    </div>
                </div>
        </div>

        <div class="tile p-6 rounded-lg">
            <div class="flex justify-between items-center mb-2">
                <h2 class="tile-title text-xl font-semibold">Task Checklist</h2>
                <button id="clear-tasks-main-button" class="button-danger-small" title="Clear All Tasks">
                    Clear All
                </button>
            </div>

            <div class="tab-container">
                <button id="tab-tasks" class="tab-button active">Tasks</button>
                <button id="tab-history" class="tab-button">History</button>
            </div>

            <div class="mb-4">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-primary-accent">Progress</span>
                    <span id="progress-percentage" class="text-sm font-medium text-primary-accent">0%</span>
                </div>
                <div class="w-full progress-bar-bg rounded-full h-2.5">
                    <div id="progress-bar-inner" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="task-list-container" class="space-y-1 max-h-60 overflow-y-auto pr-2 task-list-container">
                <p class="text-muted italic text-center p-4">Loading tasks...</p>
                </div>

            <div id="history-log-container" class="hidden space-y-1 max-h-60 overflow-y-auto pr-2 history-log-container">
                <p class="text-muted italic text-center p-4">No history yet.</p>
                </div>

            <div class="add-task-container">
                <input type="text" id="new-task-input" placeholder="Add a new task..." class="input-field">
                <button id="add-task-button" class="button-base button-add">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add
                </button>
                <button id="load-template-button" class="button-base button-load-template" title="Load tasks from template">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" x2="4" y1="22" y2="15"></line></svg> Load
                </button>
            </div>
        </div>
    </div>

    <script>
        console.log("Script start.");
        let appInitialized = false;

        // --- DOM Elements ---
        // Declare all element variables here
        let dateDisplay, timeDisplay, slotTimerDisplay, slotsPassedDisplay,
            /* REMOVED: activeHoursBarContainer, activeHoursCountSpan, activeHoursRangeDisplay, */
            activeHoursRangeDisplayInline, // ADDED: For inline display
            fullDaySlotsBarContainer,
            taskListContainer, newTaskInput, addTaskButton, loadTemplateButton,
            progressBarInner, progressPercentage,
            themeButtons, tabTasks, tabHistory, historyLogContainer,
            settingsButton, settingsModal, settingsOverlay,
            startHourSelect, endHourSelect, saveSettingsButton, closeSettingsButton,
            taskTemplateTextarea, saveTemplateButton,
            clearTasksMainButton,
            clearHistoryButton,
            confirmModal, confirmOverlay, confirmMessage, confirmYesButton, confirmNoButton;

        // --- State Variables ---
        let tasks = [];
        let nextTaskId = 1;
        let taskHistory = [];
        let taskTemplate = "";
        const DEFAULT_THEME = 'light';
        let activeStartHour = 6;
        let activeEndHour = 21;
        const SLOTS_PER_HOUR = 2;
        const TOTAL_DAY_SLOTS = 24 * SLOTS_PER_HOUR;
        let intervalId = null;
        const futureColors = ['#fde047', '#f59e0b', '#ef4444', '#ec4899', '#a855f7', '#60a5fa', '#2dd4bf', '#84cc16'];
        let currentConfirmCallback = null; // To store the function to run on confirmation

        // --- LocalStorage Keys ---
        const LS_TASKS_KEY = 'timebox-tasks';
        const LS_HISTORY_KEY = 'timebox-history';
        const LS_NEXT_ID_KEY = 'timebox-nextTaskId';
        const LS_THEME_KEY = 'timebox-theme';
        const LS_START_HOUR_KEY = 'timebox-activeStartHour';
        const LS_END_HOUR_KEY = 'timebox-activeEndHour';
        const LS_TEMPLATE_KEY = 'timebox-taskTemplate';

        // --- Utility Functions ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "--:--";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function getThemeColor(variableName, fallbackColor = '#888888') {
            try {
                // Prefer body style if available, otherwise use root
                if (document.body) {
                    const color = getComputedStyle(document.body).getPropertyValue(variableName).trim();
                    // Basic validation: Check if it starts like a color value
                    return color && (color.startsWith('#') || color.startsWith('rgb') || color.startsWith('hsl')) ? color : fallbackColor;
                }
                // Fallback to root element (might happen early in load or if body isn't styled yet)
                const rootStyle = getComputedStyle(document.documentElement);
                const color = rootStyle.getPropertyValue(variableName).trim();
                return color && (color.startsWith('#') || color.startsWith('rgb') || color.startsWith('hsl')) ? color : fallbackColor;
            } catch (e) {
                console.warn(`Error getting theme color ${variableName}:`, e);
                return fallbackColor;
            }
        }

        // --- Persistence (LocalStorage) ---
        function loadState() {
            console.log("Loading state from localStorage...");
            try {
                // Theme
                const savedTheme = localStorage.getItem(LS_THEME_KEY);
                const validThemes = ['light', 'grey', 'dark'];
                const themeToApply = validThemes.includes(savedTheme) ? savedTheme : DEFAULT_THEME;
                applyTheme(themeToApply); // Apply theme early

                // Active Hours
                const savedStart = localStorage.getItem(LS_START_HOUR_KEY);
                const savedEnd = localStorage.getItem(LS_END_HOUR_KEY);
                if (savedStart !== null) activeStartHour = parseInt(savedStart, 10);
                if (savedEnd !== null) activeEndHour = parseInt(savedEnd, 10);

                // Tasks
                const savedTasks = localStorage.getItem(LS_TASKS_KEY);
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                } else {
                    // Default tasks if none saved
                    tasks = [
                        { id: 1, text: 'Plan Your Day', completed: true },
                        { id: 2, text: 'Check and Respond to emails', completed: false },
                        { id: 3, text: 'Work on project X', completed: false },
                        { id: 4, text: 'Review Pending Items', completed: false },
                    ];
                }

                // Next Task ID
                const savedNextId = localStorage.getItem(LS_NEXT_ID_KEY);
                if (savedNextId) {
                    nextTaskId = parseInt(savedNextId, 10);
                } else {
                    // Calculate next ID based on loaded tasks
                    nextTaskId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                }

                // History
                const savedHistory = localStorage.getItem(LS_HISTORY_KEY);
                if (savedHistory) {
                    // Parse dates correctly
                    taskHistory = JSON.parse(savedHistory).map(event => ({
                        ...event,
                        timestamp: new Date(event.timestamp) // Convert string back to Date object
                    }));
                } else {
                    taskHistory = [];
                }

                 // Task Template
                const savedTemplate = localStorage.getItem(LS_TEMPLATE_KEY);
                if (savedTemplate) {
                    taskTemplate = savedTemplate;
                } else {
                    // Default template
                    taskTemplate = "Review daily goals\nCheck email\nTeam meeting\nLunch break\nFocus work block\nWrap up day";
                }


                console.log("State loaded.");
            } catch (e) {
                console.error("Could not load state from localStorage:", e);
                // Reset to defaults on error
                tasks = [
                    { id: 1, text: 'Plan morning tasks', completed: true },
                    { id: 2, text: 'Check emails', completed: false },
                    { id: 3, text: 'Work on project X', completed: false },
                    { id: 4, text: 'Lunch break', completed: false },
                ];
                taskHistory = [];
                nextTaskId = 5;
                activeStartHour = 6;
                activeEndHour = 21;
                taskTemplate = "Default task 1\nDefault task 2";
                applyTheme(DEFAULT_THEME); // Apply default theme on error
            }
            // Populate UI elements that depend on loaded state *after* loading
            populateHourSelects();
            updateActiveHoursDisplay(); // Update the inline display text
        }

        function saveState() {
            console.log("Saving state to localStorage...");
            try {
                localStorage.setItem(LS_TASKS_KEY, JSON.stringify(tasks));
                localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(taskHistory));
                localStorage.setItem(LS_NEXT_ID_KEY, nextTaskId.toString());
                localStorage.setItem(LS_TEMPLATE_KEY, taskTemplate);
                // Theme and hours are saved separately when changed
                console.log("State saved.");
            } catch (e) {
                console.error("Could not save state to localStorage:", e);
                // Optionally alert the user or implement more robust error handling
            }
        }


        // --- Confirmation Modal Logic ---
        function showConfirmationModal(message, onConfirm) {
            console.log("Attempting to show confirmation modal...");
            console.log("Confirm Modal Element:", confirmModal);
            console.log("Confirm Overlay Element:", confirmOverlay);
            console.log("Confirm Message Element:", confirmMessage);

            if (!confirmModal || !confirmOverlay || !confirmMessage) {
                console.error("Confirmation modal elements not found!");
                if (confirm("Fallback: " + message)) {
                    if (typeof onConfirm === 'function') {
                         try { onConfirm(); } catch (e) { console.error("Error in fallback confirm callback:", e); }
                    }
                }
                return;
            }

            console.log("Setting confirmation message:", message);
            confirmMessage.textContent = message;
            currentConfirmCallback = onConfirm;
            console.log("Assigning callback:", currentConfirmCallback);

            console.log("Adding 'visible' class to overlay...");
            confirmOverlay.classList.add('visible');
            console.log("Adding 'visible' class to modal...");
            confirmModal.classList.add('visible');
            console.log("Confirmation modal should now be visible.");
        }

        function hideConfirmationModal() {
            if (!confirmModal || !confirmOverlay) return;
            console.log("Hiding confirmation modal.");
            confirmOverlay.classList.remove('visible');
            confirmModal.classList.remove('visible');
            currentConfirmCallback = null;
        }

        function handleConfirmYes() {
            console.log("handleConfirmYes function called.");
            console.log("Type of currentConfirmCallback:", typeof currentConfirmCallback);
            console.log("Value of currentConfirmCallback:", currentConfirmCallback);

            if (typeof currentConfirmCallback === 'function') {
                console.log("Executing confirmation callback.");
                try {
                    currentConfirmCallback();
                } catch (error) {
                    console.error("Error executing confirmation callback:", error);
                    alert("An error occurred while performing the action.");
                }
            } else {
                 console.warn("No confirmation callback stored or it's not a function.");
            }
            hideConfirmationModal();
        }

        // --- Settings Modal Logic ---
        function openSettingsModal() {
            if (!settingsModal || !settingsOverlay || !startHourSelect || !endHourSelect || !taskTemplateTextarea) {
                console.error("Cannot open settings: one or more modal elements missing.");
                return;
            }
            startHourSelect.value = activeStartHour;
            endHourSelect.value = activeEndHour;
            taskTemplateTextarea.value = taskTemplate;
            settingsOverlay.classList.add('visible');
            settingsModal.classList.add('visible');
            console.log("Settings modal opened.");
        }

        function closeSettingsModal() {
            if (!settingsModal || !settingsOverlay) return;
            settingsOverlay.classList.remove('visible');
            settingsModal.classList.remove('visible');
            console.log("Settings modal closed.");
        }

        function saveActiveHours() {
            if (!startHourSelect || !endHourSelect) return;
            const newStart = parseInt(startHourSelect.value, 10);
            const newEnd = parseInt(endHourSelect.value, 10);

            if (isNaN(newStart) || isNaN(newEnd) || newStart >= newEnd) {
                alert("Invalid hour selection. Start hour must be before end hour.");
                return;
            }

            activeStartHour = newStart;
            activeEndHour = newEnd;

            try {
                localStorage.setItem(LS_START_HOUR_KEY, activeStartHour);
                localStorage.setItem(LS_END_HOUR_KEY, activeEndHour);
                console.log("Active hours saved to localStorage:", activeStartHour, activeEndHour);
            } catch (e) {
                console.error("Could not save active hours to localStorage:", e);
                alert("Error saving hours settings.");
            }

            updateActiveHoursDisplay(); // Update the inline display text
            // generateActiveHoursBar(); // REMOVED: No longer needed
            updateDateTime(); // Force immediate update of highlights on the full day bar

            alert("Active hours saved!");
        }

        function populateHourSelects() {
            if (!startHourSelect || !endHourSelect) {
                console.error("Hour select elements not found for population.");
                return;
            }
            startHourSelect.innerHTML = '';
            endHourSelect.innerHTML = '';

            for (let i = 0; i < 24; i++) {
                const startOption = document.createElement('option');
                startOption.value = i;
                startOption.textContent = `${String(i).padStart(2, '0')}:00`;
                startHourSelect.appendChild(startOption);

                const endOption = document.createElement('option');
                endOption.value = i + 1;
                endOption.textContent = `${String(i + 1).padStart(2, '0')}:00`;
                endHourSelect.appendChild(endOption);
            }
        }

        function formatHourForDisplay(hour) {
            if (hour === 0 || hour === 24) return '12a';
            if (hour === 12) return '12p';
            if (hour < 12) return `${hour}a`;
            return `${hour - 12}p`;
        }

        // --- MODIFIED: Updates the inline text display ---
        function updateActiveHoursDisplay() {
            if (!activeHoursRangeDisplayInline) { // Use the new inline span ID
                console.error("activeHoursRangeDisplayInline element not found");
                return;
            }
            activeHoursRangeDisplayInline.textContent = `${formatHourForDisplay(activeStartHour)}-${formatHourForDisplay(activeEndHour)}`;
        }


        // --- Task Template Logic ---
        function saveTaskTemplate() {
            if (!taskTemplateTextarea) return;
            taskTemplate = taskTemplateTextarea.value;
            try {
                localStorage.setItem(LS_TEMPLATE_KEY, taskTemplate);
                console.log("Task template saved to localStorage.");
                alert("Task template saved successfully!");
            } catch (e) {
                console.error("Could not save task template to localStorage:", e);
                alert("Error saving task template.");
            }
        }

        function loadTaskTemplate() {
            console.log("loadTaskTemplate function called.");
            if (!taskTemplate) {
                console.log("No task template found in state.");
                alert("No task template saved yet. Define one in Settings.");
                return;
            }
            console.log("Current task template:", taskTemplate);

            showConfirmationModal(
                "This will replace your current tasks with the template. Are you sure?",
                () => {
                    console.log("Load template confirmed by user via custom modal.");
                    try {
                        const templateLines = taskTemplate.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0);

                        console.log("Parsed template lines:", templateLines);

                        if (templateLines.length === 0) {
                            console.log("Template is empty after parsing.");
                            alert("Template is empty or contains only whitespace.");
                            return;
                        }

                        tasks = [];
                        nextTaskId = 1;
                        console.log("Cleared tasks array, resetting nextTaskId to 1.");

                        templateLines.forEach(line => {
                            const newTask = {
                                id: nextTaskId++,
                                text: line,
                                completed: false
                            };
                            tasks.push(newTask);
                            console.log("Added task from template:", newTask);
                        });

                        console.log("Logging history event for template load...");
                        logHistoryEvent('template', `Loaded ${templateLines.length} tasks`);

                        console.log("Rendering tasks...");
                        renderTasks();

                        console.log("Load template process finished.");
                        alert(`Loaded ${templateLines.length} tasks from template.`);

                    } catch (error) {
                        console.error("Error loading task template:", error);
                        alert("An error occurred while loading the template.");
                    }
                }
            );
        }

        // --- Clear Functions ---
        function clearAllTasks() {
            console.log("clearAllTasks function called.");
            if (tasks.length === 0) {
                alert("Task list is already empty.");
                return;
            }

            showConfirmationModal(
                "Are you sure you want to delete ALL tasks? This cannot be undone.",
                () => {
                    console.log("Clear tasks confirmed by user via custom modal.");
                    try {
                        const count = tasks.length;
                        tasks = [];
                        console.log("Tasks array cleared. Logging history event...");
                        logHistoryEvent('cleared', `Cleared ${count} tasks`);

                        console.log("Rendering tasks...");
                        renderTasks();

                        console.log("Clear tasks process finished.");
                        alert(`Cleared ${count} tasks.`);
                    } catch(e) {
                         console.error("Error clearing tasks:", e);
                         alert("An error occurred while clearing tasks.");
                    }
                }
            );
        }

        function clearHistory() {
            console.log("clearHistory function called.");
            if (taskHistory.length === 0) {
                alert("History is already empty.");
                return;
            }

            showConfirmationModal(
                "Are you sure you want to clear the entire task history? This cannot be undone.",
                () => {
                    console.log("Executing 'Clear History' confirmation callback.");
                    try {
                        const count = taskHistory.length;
                        console.log(`Current history length: ${count}. Clearing array...`);
                        taskHistory = [];
                        console.log("History array cleared. Saving state...");
                        saveState();
                        console.log("Checking if history tab is active...");
                        if (tabHistory && tabHistory.classList.contains('active')) {
                            console.log("History tab is active, rendering history...");
                            renderHistory();
                        }
                        console.log("Clear history process finished inside callback.");
                        alert(`Cleared ${count} history events.`);
                    } catch(e) {
                        console.error("Error inside clearHistory callback:", e);
                        alert("An error occurred while clearing history.");
                    }
                }
            );
        }


        // --- Theme Management ---
        function applyTheme(themeName) {
            console.log(`Applying theme: ${themeName}`);
            document.body.dataset.theme = themeName;

            if(themeButtons){
                themeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.themeValue === themeName);
                });
            } else {
                console.warn("Theme buttons not found when applying theme.");
            }

            if(appInitialized) {
                 updateDateTime();
            }
        }

        function setupThemeSwitcher() {
            console.log("Setting up theme switcher...");
            if (!themeButtons || themeButtons.length === 0) {
                console.error("Theme buttons not found during setup.");
                return;
            }
            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedTheme = button.dataset.themeValue;
                    applyTheme(selectedTheme);
                    try {
                        localStorage.setItem(LS_THEME_KEY, selectedTheme);
                    } catch (e) {
                        console.error("Could not save theme to localStorage:", e);
                    }
                });
            });
            const currentTheme = document.body.dataset.theme || DEFAULT_THEME;
            applyTheme(currentTheme);

            console.log(`Initial theme setup complete. Current theme: ${currentTheme}`);
        }

        // --- Date, Time & Slot Update ---
        function updateDateTime() {
            try {
                const now = new Date();

                const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
                if (dateDisplay) dateDisplay.textContent = now.toLocaleDateString('en-GB', dateOptions);
                else console.warn("dateDisplay element not found during update.");

                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                if (timeDisplay) timeDisplay.textContent = now.toLocaleTimeString('en-US', timeOptions).toLowerCase();
                else console.warn("timeDisplay element not found during update.");

                // updateActiveHoursHighlight(now); // REMOVED: Logic merged below
                updateFullDaySlotsHighlight(now); // This now handles active hour styling too
                updateSlotTimer(now);

            } catch (error) {
                console.error("Error in updateDateTime:", error);
                if(intervalId) clearInterval(intervalId);
            }
        }

        // --- Time Bars ---
        // REMOVED: generateActiveHoursBar function

        function generateTimeBlocks(container, totalSlots) { // Simplified: Only generates full day now
             if (!container) {
                console.error(`Container element not found for generating full day bar.`);
                return 0;
            }
            container.innerHTML = '';
            let generatedCount = 0;

            for (let i = 0; i < totalSlots; i++) {
                const block = document.createElement('div');
                block.classList.add('time-block');
                const actualSlotIndex24 = i; // Index is direct for full day bar
                block.dataset.slotIndex24 = actualSlotIndex24;

                const hour = Math.floor(actualSlotIndex24 / SLOTS_PER_HOUR);
                const minute = (actualSlotIndex24 % SLOTS_PER_HOUR) * 30;
                const timeString = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                block.title = `Slot: ${timeString}`;

                container.appendChild(block);
                generatedCount++;
            }
            console.log(`Generated ${generatedCount} full day slot blocks.`);
            return generatedCount;
        }

        function generateFullDaySlotsBar() {
            console.log("Generating full day slots bar...");
            generateTimeBlocks(fullDaySlotsBarContainer, TOTAL_DAY_SLOTS);
        }

        // REMOVED: updateActiveHoursHighlight function

        // --- MODIFIED: updateHighlightGeneric is now only for the full day bar ---
        // --- and includes logic to add 'active-hour-slot' class ---
        function updateFullDaySlotsHighlight(currentTime) {
            const container = fullDaySlotsBarContainer; // Directly use the full day container
            if (!container) {
                console.warn(`Full day slots container not found for highlighting`);
                return;
            }
            try {
                const currentHour = currentTime.getHours();
                const currentMinute = currentTime.getMinutes();
                const currentSlotIndex24 = Math.floor((currentHour * 60 + currentMinute) / 30);

                const defaultBorderColor = getThemeColor('--grid-border', '#e2e8f0');

                const slotBlocks = container.querySelectorAll('.time-block');
                if (slotBlocks.length === 0) return;

                const activeStartSlotIndex = activeStartHour * SLOTS_PER_HOUR;
                const activeEndSlotIndex = activeEndHour * SLOTS_PER_HOUR; // Exclusive end

                let futureBlockCounter = 0;

                slotBlocks.forEach(block => {
                    const slotIndex24 = parseInt(block.dataset.slotIndex24, 10);
                    if (isNaN(slotIndex24)) return;

                    // Reset classes first
                    block.className = 'time-block'; // Base class only
                    // Reset relevant styles (important if switching states)
                    block.style.background = '';
                    block.style.borderColor = ''; // Will be overridden by state classes
                    block.style.boxShadow = '';
                    block.style.opacity = '';
                    block.style.transform = '';
                    block.style.zIndex = '';
                    block.style.position = '';
                    block.style.borderTopWidth = ''; // Reset active indicator
                    block.style.borderTopColor = ''; // Reset active indicator

                    // Determine if the slot is within active hours
                    const isActiveHour = slotIndex24 >= activeStartSlotIndex && slotIndex24 < activeEndSlotIndex;

                    // Apply state class (past, current, future)
                    if (slotIndex24 < currentSlotIndex24) {
                        block.classList.add('past');
                    } else if (slotIndex24 === currentSlotIndex24) {
                        block.classList.add('current');
                    } else {
                        block.classList.add('future');
                        // Apply cycling future colors
                        const colorIndex = futureBlockCounter % futureColors.length;
                        const blockColor = futureColors[colorIndex];
                        block.style.background = blockColor;
                        // Future blocks use default border unless active
                        block.style.borderColor = defaultBorderColor;
                        futureBlockCounter++;
                    }

                    // Apply active hour class if applicable (adds the top border via CSS)
                    if (isActiveHour) {
                        block.classList.add('active-hour-slot');
                    }
                });

            } catch (error) {
                console.error(`Error updating full day highlights:`, error);
            }
        }


        // --- Current Slot Timer Logic (Tile 2) ---
        function updateSlotTimer(now) {
            try {
                if (!slotTimerDisplay || !slotsPassedDisplay) return;

                const currentMinutes = now.getMinutes();
                const currentSeconds = now.getSeconds();
                const minutesIntoSlot = currentMinutes % 30;
                const secondsIntoSlot = minutesIntoSlot * 60 + currentSeconds;
                const totalSecondsInSlot = 30 * 60;
                const secondsRemaining = Math.max(0, totalSecondsInSlot - secondsIntoSlot - 1);

                slotTimerDisplay.textContent = formatTime(secondsRemaining);

                const currentHour = now.getHours();
                const currentTotalMinutes = currentHour * 60 + currentMinutes;
                const currentSlotIndex = Math.floor(currentTotalMinutes / 30);
                slotsPassedDisplay.textContent = `${currentSlotIndex + 1} of ${TOTAL_DAY_SLOTS} slots passed`;

            } catch (error) {
                console.error("Error updating slot timer:", error);
                if (slotTimerDisplay) slotTimerDisplay.textContent = "Error";
                if (slotsPassedDisplay) slotsPassedDisplay.textContent = "Error loading slot info";
            }
        }

        // --- Task History ---
        function logHistoryEvent(action, taskText) {
            try {
                const textToLog = typeof taskText === 'string' ? taskText.substring(0, 100) : 'Invalid Text';

                const event = {
                    timestamp: new Date(),
                    action: action,
                    taskText: textToLog
                };

                taskHistory.unshift(event);

                if (taskHistory.length > 100) {
                    taskHistory.pop();
                }

                console.log("History event logged:", event);
                saveState();

                if (tabHistory && tabHistory.classList.contains('active')) {
                    renderHistory();
                }
            } catch(e) {
                console.error("Error logging history event:", e);
            }
        }

        function renderHistory() {
            if (!historyLogContainer) {
                console.error("History container not found for rendering.");
                return;
            }
            try {
                historyLogContainer.innerHTML = '';

                if (taskHistory.length === 0) {
                    historyLogContainer.innerHTML = '<p class="text-muted italic text-center p-4">No history yet.</p>';
                    return;
                }

                const historyFragment = document.createDocumentFragment();

                taskHistory.forEach(event => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'history-entry';

                    const timestampSpan = document.createElement('span');
                    timestampSpan.className = 'history-timestamp';
                    timestampSpan.textContent = event.timestamp instanceof Date
                        ? event.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        : 'Invalid Date';

                    const detailsSpan = document.createElement('span');
                    detailsSpan.className = 'history-details';

                    const actionSpan = document.createElement('span');
                    const actionClass = String(event.action).replace(/[^a-z0-9]/gi, '').toLowerCase();
                    actionSpan.className = `history-action history-action-${actionClass}`;
                    actionSpan.textContent = `${event.action.charAt(0).toUpperCase() + event.action.slice(1)}: `;

                    const textSpan = document.createElement('span');
                    textSpan.className = 'history-text';
                    textSpan.textContent = event.taskText;

                    detailsSpan.appendChild(actionSpan);
                    detailsSpan.appendChild(textSpan);

                    entryDiv.appendChild(detailsSpan);
                    entryDiv.appendChild(timestampSpan);

                    historyFragment.appendChild(entryDiv);
                });

                historyLogContainer.appendChild(historyFragment);

            } catch (error) {
                console.error("Error rendering history:", error);
                historyLogContainer.innerHTML = '<p class="text-red-500 italic text-center p-4">Error loading history.</p>';
            }
        }


        // --- Task Checklist ---
        function renderTasks() {
            if (!taskListContainer) {
                console.error("Task list container not found in renderTasks");
                return;
            }
            try {
                taskListContainer.innerHTML = '';

                if (tasks.length === 0) {
                    taskListContainer.innerHTML = '<p class="text-muted italic text-center p-4">No tasks yet. Add one below or load a template!</p>';
                } else {
                    const taskFragment = document.createDocumentFragment();

                    tasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                        taskElement.dataset.taskId = task.id;

                        const label = document.createElement('label');

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = task.completed;
                        checkbox.addEventListener('change', () => toggleTask(task.id));

                        const taskText = document.createElement('span');
                        taskText.textContent = task.text;

                        label.appendChild(checkbox);
                        label.appendChild(taskText);

                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'delete-button';
                        deleteButton.title = 'Delete Task';
                        deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
                        deleteButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteTask(task.id);
                        });

                        taskElement.appendChild(label);
                        taskElement.appendChild(deleteButton);

                        taskFragment.appendChild(taskElement);
                    });

                    taskListContainer.appendChild(taskFragment);
                }

                updateProgressBar();
                saveState();

            } catch (error) {
                console.error("Error rendering tasks:", error);
                taskListContainer.innerHTML = '<p class="text-red-500 italic text-center p-4">Error loading tasks.</p>';
            }
        }

        function addTask() {
            console.log("addTask called");
            if (!newTaskInput || !taskListContainer) {
                console.error("Missing elements for addTask (input or container)");
                return;
            }
            const text = newTaskInput.value.trim();
            console.log("Task text:", text);

            if (text) {
                try {
                    const newTask = {
                        id: nextTaskId++,
                        text: text,
                        completed: false
                    };
                    tasks.push(newTask);
                    logHistoryEvent('added', text);
                    newTaskInput.value = '';
                    renderTasks();
                } catch (error) {
                    console.error("Error adding task:", error);
                    alert("Failed to add task.");
                }
            } else {
                console.log("Task text is empty, not adding.");
            }
        }

        function toggleTask(id) {
            try {
                const taskIndex = tasks.findIndex(task => task.id === id);
                if (taskIndex === -1) {
                    console.warn(`Task with id ${id} not found for toggling.`);
                    return;
                }

                const task = tasks[taskIndex];
                const originalText = task.text;
                const wasCompleted = task.completed;

                tasks[taskIndex] = { ...task, completed: !wasCompleted };

                logHistoryEvent(wasCompleted ? 'uncompleted' : 'completed', originalText);

                renderTasks();
            } catch(e) {
                console.error(`Error toggling task with id ${id}:`, e);
                alert("Failed to update task status.");
            }
        }

        function deleteTask(id) {
             try {
                const taskIndex = tasks.findIndex(task => task.id === id);
                if (taskIndex === -1) {
                    console.warn(`Task with id ${id} not found for deletion.`);
                    return;
                }

                const taskToDelete = tasks[taskIndex];
                logHistoryEvent('deleted', taskToDelete.text);

                tasks.splice(taskIndex, 1);

                renderTasks();
            } catch(e) {
                console.error(`Error deleting task with id ${id}:`, e);
                alert("Failed to delete task.");
            }
        }

        // --- Progress Bar ---
        function updateProgressBar() {
            if (!progressBarInner || !progressPercentage) {
                 return;
            }
            const completedTasks = tasks.filter(task => task.completed).length;
            const totalTasks = tasks.length;
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            progressBarInner.style.width = `${percentage}%`;
            progressPercentage.textContent = `${percentage}%`;
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            try {
                // Add Task
                if (addTaskButton) {
                    addTaskButton.removeEventListener('click', addTask);
                    addTaskButton.addEventListener('click', addTask);
                } else console.error("Add task button not found for listener.");

                if (newTaskInput) {
                    newTaskInput.removeEventListener('keypress', handleTaskInputKeypress);
                    newTaskInput.addEventListener('keypress', handleTaskInputKeypress);
                } else console.error("New task input not found for listener.");

                // Load Template
                if (loadTemplateButton) {
                    loadTemplateButton.removeEventListener('click', loadTaskTemplate);
                    loadTemplateButton.addEventListener('click', loadTaskTemplate);
                } else console.error("Load template button not found for listener.");

                // Tabs
                if (tabTasks && tabHistory) {
                    tabTasks.removeEventListener('click', showTasksTab);
                    tabTasks.addEventListener('click', showTasksTab);
                    tabHistory.removeEventListener('click', showHistoryTab);
                    tabHistory.addEventListener('click', showHistoryTab);
                } else console.error("Tab elements not found for listeners.");

                // Clear Tasks (Main Button in Task List)
                if (clearTasksMainButton) {
                    clearTasksMainButton.removeEventListener('click', clearAllTasks);
                    clearTasksMainButton.addEventListener('click', clearAllTasks);
                } else console.error("Clear tasks main button not found for listener.");

                // Settings Modal Controls
                if(settingsButton) settingsButton.addEventListener('click', openSettingsModal);
                else console.error("Settings button not found for listener.");

                if(closeSettingsButton) closeSettingsButton.addEventListener('click', closeSettingsModal);
                else console.error("Close settings button not found for listener.");

                if(settingsOverlay) settingsOverlay.addEventListener('click', closeSettingsModal);
                else console.error("Settings overlay not found for listener.");

                if(saveSettingsButton) saveSettingsButton.addEventListener('click', saveActiveHours);
                else console.error("Save settings button not found for listener.");

                if(saveTemplateButton) saveTemplateButton.addEventListener('click', saveTaskTemplate);
                else console.error("Save template button not found for listener.");

                // Clear History (Button inside Settings Modal)
                if(clearHistoryButton) {
                    clearHistoryButton.removeEventListener('click', clearHistory);
                    clearHistoryButton.addEventListener('click', () => {
                        console.log("Clear History button (in settings) clicked!");
                        clearHistory();
                    });
                } else console.error("Clear history button not found for listener.");

                // Confirmation Modal Buttons
                if(confirmNoButton) confirmNoButton.addEventListener('click', hideConfirmationModal);
                else console.error("Confirm No button not found for listener.");

                if(confirmYesButton) confirmYesButton.addEventListener('click', handleConfirmYes);
                else console.error("Confirm Yes button not found for listener.");

                if(confirmOverlay) confirmOverlay.addEventListener('click', hideConfirmationModal);
                else console.error("Confirm overlay not found for listener.");


            } catch (error) {
                console.error("Error setting up event listeners:", error);
            }
            console.log("Event listeners setup finished.");
        }

        // Handler for Enter key in task input
        function handleTaskInputKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addTask();
            }
        }

        // Tab Switching Logic
        function showTasksTab() {
            if (!taskListContainer || !historyLogContainer || !tabTasks || !tabHistory) return;
            taskListContainer.classList.remove('hidden');
            historyLogContainer.classList.add('hidden');
            tabTasks.classList.add('active');
            tabHistory.classList.remove('active');
        }

        function showHistoryTab() {
            if (!taskListContainer || !historyLogContainer || !tabTasks || !tabHistory) return;
            taskListContainer.classList.add('hidden');
            historyLogContainer.classList.remove('hidden');
            tabTasks.classList.remove('active');
            tabHistory.classList.add('active');
            renderHistory();
        }

        // --- Initial Setup ---
        function initializeApp() {
            if (appInitialized) {
                console.warn("App already initialized. Skipping.");
                return;
            }
            console.log("Initializing App...");

            try {
                console.log("Step 1: Selecting DOM elements...");
                // Define required IDs, excluding the removed active hours bar elements
                const requiredIds = [
                    'date-display', 'time-display', 'slot-timer-display', 'slots-passed',
                    'active-hours-range-display-inline', // ADDED check for new inline display
                    'full-day-slots-bar', 'task-list-container', 'new-task-input',
                    'add-task-button', 'load-template-button', 'progress-bar-inner',
                    'progress-percentage', 'tab-tasks', 'tab-history', 'history-log-container',
                    'settings-button', 'settings-modal', 'settings-overlay',
                    'setting-start-hour', 'setting-end-hour', 'save-settings-button',
                    'close-settings-button', 'setting-task-template', 'save-template-button',
                    'clear-tasks-main-button', 'clear-history-button',
                    'confirm-modal', 'confirm-overlay', 'confirm-message',
                    'confirm-yes-button', 'confirm-no-button'
                ];
                let missingElement = false;
                requiredIds.forEach(id => {
                    if (!document.getElementById(id)) {
                        console.error(`Critical Error: Element with ID '${id}' not found.`);
                        missingElement = true;
                    }
                });
                themeButtons = document.querySelectorAll('.theme-button');
                if (!themeButtons || themeButtons.length === 0) {
                     console.error("Critical Error: Elements with class '.theme-button' not found.");
                     missingElement = true;
                }

                if (missingElement) {
                    throw new Error("One or more required HTML elements are missing. Cannot initialize app.");
                }

                // Assign elements to variables
                dateDisplay = document.getElementById('date-display');
                timeDisplay = document.getElementById('time-display');
                slotTimerDisplay = document.getElementById('slot-timer-display');
                slotsPassedDisplay = document.getElementById('slots-passed');
                activeHoursRangeDisplayInline = document.getElementById('active-hours-range-display-inline'); // Assign new element
                fullDaySlotsBarContainer = document.getElementById('full-day-slots-bar');
                taskListContainer = document.getElementById('task-list-container');
                newTaskInput = document.getElementById('new-task-input');
                addTaskButton = document.getElementById('add-task-button');
                loadTemplateButton = document.getElementById('load-template-button');
                progressBarInner = document.getElementById('progress-bar-inner');
                progressPercentage = document.getElementById('progress-percentage');
                // themeButtons selected above
                tabTasks = document.getElementById('tab-tasks');
                tabHistory = document.getElementById('tab-history');
                historyLogContainer = document.getElementById('history-log-container');
                settingsButton = document.getElementById('settings-button');
                settingsModal = document.getElementById('settings-modal');
                settingsOverlay = document.getElementById('settings-overlay');
                startHourSelect = document.getElementById('setting-start-hour');
                endHourSelect = document.getElementById('setting-end-hour');
                saveSettingsButton = document.getElementById('save-settings-button');
                closeSettingsButton = document.getElementById('close-settings-button');
                taskTemplateTextarea = document.getElementById('setting-task-template');
                saveTemplateButton = document.getElementById('save-template-button');
                clearTasksMainButton = document.getElementById('clear-tasks-main-button');
                clearHistoryButton = document.getElementById('clear-history-button');
                confirmModal = document.getElementById('confirm-modal');
                confirmOverlay = document.getElementById('confirm-overlay');
                confirmMessage = document.getElementById('confirm-message');
                confirmYesButton = document.getElementById('confirm-yes-button');
                confirmNoButton = document.getElementById('confirm-no-button');

                console.log("Step 1: Finished selecting DOM elements successfully.");

                console.log("Step 2: Loading state...");
                loadState();
                console.log("Step 2: Finished loading state.");

                console.log("Step 3: Setting up theme switcher...");
                setupThemeSwitcher();
                console.log("Step 3: Finished setting up theme switcher.");

                console.log("Step 4: Generating time bars/grids...");
                // generateActiveHoursBar(); // REMOVED
                generateFullDaySlotsBar();
                console.log("Step 4: Finished generating time bars/grids.");

                console.log("Step 5: Rendering initial tasks...");
                renderTasks();
                console.log("Step 5: Finished rendering initial tasks.");

                console.log("Step 6: Setting up event listeners...");
                setupEventListeners();
                console.log("Step 6: Finished setting up event listeners.");

                console.log("Step 7: Performing initial date/time update and highlights...");
                updateDateTime();
                console.log("Step 7: Finished initial date/time update.");

                console.log("Step 8: Setting up update interval...");
                if (intervalId) clearInterval(intervalId);
                intervalId = setInterval(updateDateTime, 1000);
                console.log("Step 8: Finished setting up update interval.");

                console.log("Step 9: Setting initial tab...");
                showTasksTab();
                console.log("Step 9: Finished setting initial tab.");

                // Ensure modals are hidden initially
                if(settingsOverlay) settingsOverlay.classList.remove('visible');
                if(settingsModal) settingsModal.classList.remove('visible');
                if(confirmOverlay) confirmOverlay.classList.remove('visible');
                if(confirmModal) confirmModal.classList.remove('visible');

                appInitialized = true;
                console.log("App Initialized successfully.");

            } catch(error) {
                console.error("CRITICAL ERROR during app initialization:", error);
                appInitialized = false;
                const body = document.querySelector('body');
                if (body) {
                     body.innerHTML = `<div class="fixed inset-0 flex items-center justify-center bg-red-100 p-4"><div class="text-center"><h2 class="text-xl font-bold text-red-700 mb-2">Application Error</h2><p class="text-red-600">Could not load the Daily Dash app due to an internal error. Please check the developer console (F12) for details or try refreshing the page.</p><p class="text-sm text-red-500 mt-2">Error: ${error.message || 'Unknown error'}</p></div></div>`;
                }
                if (intervalId) clearInterval(intervalId);
            }
        }

        // --- Run Init ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        console.log("Script end.");
    </script>
</body>
</html>
